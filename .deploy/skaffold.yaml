apiVersion: skaffold/v3
kind: Config
metadata:
  name: lucas-app

build:
  artifacts:
  - image: my-nginx
    context: nginx
    docker:
      dockerfile: Dockerfile-nginx
    # TODO: Uncomment when there are actual HTML files inside the nginx/html folder.
    #sync:
    #  # Auto-sync changes for faster development
    #  manual:
    #    - src: "nginx/html/**"
    #      dest: "/usr/share/nginx/html"
  - image: certbot/certbot:latest
  local:
    push: false
    useDockerCLI: true
    useBuildkit: false

manifests:
  rawYaml:
    - k8s/nginx-deployment.yaml
    - k8s/certbot-pvc.yaml
    - k8s/certbot-initial.yaml

portForward:
  - resourceType: service
    resourceName: nginx-service
    port: 80
    localPort: 8080 # Access at http://localhost:8080
#  - resourceType: service
#    resourceName: prometheus-service
#    port: 9090
#    localPort: 9090
#  - resourceType: service
#    resourceName: grafana-service
#    port: 3000
#    localPort: 3000
#  - resourceType: service
#    resourceName: your-app-service
#    port: 8080
#    localPort: 8080
deploy:
  kubectl: {}

# Defining environment variables at root level
env:
  # Read from .env file or environment
  - name: CERTBOT_EMAIL
    value: "your-default@example.com"  # Default email
  - name: APPLICATION_DOMAIN
    value: "example.com"  # Default domain
  - name: APPLICATION_API_DOMAIN
    value: "api.example.com"  # Default api.domain

# Defining profiles
profiles:
  - name: nginx-ssl # Add SSL certificates to the domain
    activation:
      - command: nginx-ssl
    build:
      artifacts:
        - image: my-nginx
          context: nginx
          docker:
            dockerfile: Dockerfile-nginx-ssl
        - image: certbot/certbot:latest
      local:
        push: false
        useDockerCLI: true
        useBuildkit: false

    # Profiles can override environment variables
    env:
      - name: CERTBOT_EMAIL
        value: "ssl-email@example.com"  # Override for SSL profile
      - name: APPLICATION_DOMAIN
        value: "ssl-domain.com"
      - name: APPLICATION_API_DOMAIN
        value: "api.ssl-domain.com"
    
    manifests:
      rawYaml:
        - k8s/nginx-deployment.yaml
        - k8s/nginx-service.yaml
    
    deploy:
      kubectl: {}