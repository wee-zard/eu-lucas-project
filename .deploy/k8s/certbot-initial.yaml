# k8s/certbot-initial.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: certbot-initial
spec:
  #ttlSecondsAfterFinished: 86400  # Delete after 24 hours
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: nginx-challenge-server
        image: nginx:alpine
        command: ["sh", "-c"]
        args:
          - |
            mkdir -p /var/www/html/.well-known/acme-challenge
            echo "Challenge server ready" > /var/www/html/index.html
            nginx -g "daemon off;"
        volumeMounts:
        - name: webroot
          mountPath: /var/www/html
        #- name: nginx-config
        #  mountPath: /etc/nginx/conf.d/default.conf
        #  subPath: default.conf
        ports:
        - containerPort: 80
      containers:
      - name: certbot
        image: certbot/certbot:latest
        command: ["certbot"]
        args:
          - "certonly"
          - "--webroot"
          - "-w"
          - "/var/www/html"
          - "--force-renewal"
          - "--email"
          - "${CERTBOT_EMAIL}"
          - "-d"
          - "${APPLICATION_DOMAIN}"
          - "-d"
          - "api.${APPLICATION_DOMAIN}"
          - "--agree-tos"
        env:
        - name: CERTBOT_EMAIL
          value: "${CERTBOT_EMAIL}"
        - name: APPLICATION_DOMAIN
          value: "${APPLICATION_DOMAIN}"
        volumeMounts:
        - name: certbot-certs
          mountPath: /etc/letsencrypt
        - name: webroot
          mountPath: /var/www/html
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: certbot-certs
          mountPath: /etc/letsencrypt
      volumes:
      - name: certbot-certs
        persistentVolumeClaim:
          claimName: certbot-pvc
      - name: webroot
        emptyDir: {}
      #- name: nginx-config
      #  configMap:
      #    name: nginx-challenge-config